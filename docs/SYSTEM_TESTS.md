# System Tests Guide

System tests for membench verify the tool's behavior against a real memcached daemon using realistic traffic generated by memtier_benchmark.

## Prerequisites

### Required Tools

```bash
# macOS
brew install memcached memtier-benchmark

# Ubuntu/Debian
sudo apt-get install memcached memtier

# Fedora/RHEL
sudo dnf install memcached memtier-benchmark
```

### Verify Installation

```bash
which memcached      # Check memcached is installed
which memtier_benchmark  # Check memtier_benchmark is installed
memcached --version  # Verify version
memtier_benchmark --version  # Verify version
```

## Running System Tests

### Option 1: Run all system tests

```bash
cargo test --test system_tests -- --ignored --nocapture
```

### Option 2: Run a specific test

```bash
# Test 1: Memcached liveness
cargo test --test system_tests test_memcached_liveness -- --ignored --nocapture

# Test 2: memtier_benchmark load generation
cargo test --test system_tests test_memtier_load_generation -- --ignored --nocapture

# Test 3: ASCII protocol workload
cargo test --test system_tests test_memtier_with_ascii_protocol -- --ignored --nocapture

# Test 4: Capture/Analyze/Replay workflow
cargo test --test system_tests test_capture_analyze_replay_workflow -- --ignored --nocapture

# Test 5: Workload characteristics
cargo test --test system_tests test_workload_characteristics -- --ignored --nocapture
```

### Option 3: Run with custom output

```bash
# Verbose output with thread info
RUST_LOG=debug cargo test --test system_tests -- --ignored --nocapture --test-threads=1

# Suppress memtier output and only show results
cargo test --test system_tests -- --ignored
```

## Test Descriptions

### Test 1: Memcached Liveness (`test_memcached_liveness`)

**What it does:**
- Verifies that memcached daemon is available
- Verifies that memtier_benchmark is installed
- Starts a memcached instance on `127.0.0.1:11211`
- Sends version command to verify responsiveness
- Cleanly shuts down memcached

**Expected output:**
```
=== TEST: Memcached Liveness ===
Started memcached on 127.0.0.1:11211
✓ memcached started successfully
✓ memcached is responding to commands
✓ memcached stopped cleanly
```

**Troubleshooting:**
- If it says "memcached not found": Install memcached (see Prerequisites)
- If port 11211 is already in use: Kill existing memcached: `pkill memcached`

### Test 2: memtier_benchmark Load Generation (`test_memtier_load_generation`)

**What it does:**
- Starts memcached
- Generates light load: 2 clients, 100 requests each, 5 second test
- Uses ASCII protocol (what membench supports)
- Verifies load generation succeeds
- Cleans up

**Expected output:**
```
=== TEST: memtier_benchmark Load Generation ===
Started memcached on 127.0.0.1:11211
✓ memtier_benchmark load generation succeeded
```

**Metrics shown:**
```
memtier_benchmark output:
[output of memtier benchmark with throughput, latencies, etc.]
```

### Test 3: ASCII Protocol Workload (`test_memtier_with_ascii_protocol`)

**What it does:**
- Starts memcached
- Flushes any existing data
- Generates 50 requests from 1 client over 3 seconds using ASCII protocol
- Extracts throughput metrics from output
- Verifies throughput > 0 (workload executed successfully)

**Expected output:**
```
=== TEST: memtier_benchmark with ASCII Protocol ===
Started memcached on 127.0.0.1:11211
✓ ASCII protocol load generation succeeded
Benchmark output:
[memtier output...]
✓ Extracted throughput: 1234.56 Ops/sec
```

**Why ASCII protocol?**
membench currently parses memcache ASCII protocol (text-based commands with `\r\n` delimiters). This test verifies that memtier_benchmark can generate traffic in the protocol that membench understands.

### Test 4: Capture/Analyze/Replay Workflow (`test_capture_analyze_replay_workflow`)

**What it does:**
- Demonstrates the full membench workflow structure
- Starts memcached
- Generates load with memtier_benchmark
- Shows what would happen if capture data was available:
  - Read profile with `ProfileReader`
  - Analyze distributions with `DistributionAnalyzer`
  - Generate traffic with `TrafficGenerator`

**Expected output:**
```
=== TEST: Capture → Analyze → Replay Workflow ===
Step 1: Starting memcached...
Started memcached on 127.0.0.1:11211
Step 2: Generating load with memtier_benchmark...
✓ memtier_benchmark load generation succeeded
Step 3: Profile captured: false (file would be created by: membench record)
Step 4: If profile existed, would:
  - Read with ProfileReader::new()
  - Analyze with DistributionAnalyzer::analyze()
  - Generate traffic with TrafficGenerator::new()
✓ Workflow structure validated
```

**Note:** This test validates the structure. Full end-to-end testing requires implementing live packet capture integration.

### Test 5: Workload Characteristics (`test_workload_characteristics`)

**What it does:**
- Tests three workload intensities against memcached:
  - **Light**: 1 client, 50 requests, 3 seconds
  - **Moderate**: 2 clients, 100 requests, 5 seconds
  - **Heavy**: 4 clients, 200 requests, 10 seconds
- Collects throughput (Ops/sec) and latency metrics
- Demonstrates realistic workload patterns

**Expected output:**
```
=== TEST: Workload Characteristics ===
Testing workload: light (1 clients, 50 requests, 3 sec)
  Throughput:    1234.56 Ops/sec
  Avg. Latency:  0.81 msec

Testing workload: moderate (2 clients, 100 requests, 5 sec)
  Throughput:    2456.78 Ops/sec
  Avg. Latency:  0.82 msec

Testing workload: heavy (4 clients, 200 requests, 10 sec)
  Throughput:    4567.89 Ops/sec
  Avg. Latency:  0.87 msec

✓ Workload characteristics tested
```

## Test Environment

### Port Management

- Default memcached port: `127.0.0.1:11211`
- Tests will fail if another process is using port 11211
- Kill conflicts: `pkill memcached` or `lsof -i :11211`

### Memory Settings

- Memcached allocated 256MB during tests
- Safe for most systems
- Modify in `tests/system_tests.rs` if needed

### Protocol

All tests use memcache ASCII protocol (`--protocol=memcache_text`) because:
- membench currently implements ASCII protocol parsing
- ASCII is text-based and human-readable
- ASCII works with all memcached versions
- ASCII is suitable for observing traffic patterns

### Timeouts

- Memcached startup: 5 second wait
- Load generation: varies (3-10 seconds per test)
- Total test suite runtime: ~2-3 minutes

## Integration with CI/CD

### GitHub Actions Example

```yaml
name: System Tests

on: [push, pull_request]

jobs:
  system_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y memcached memtier
      - name: Run system tests
        run: cargo test --test system_tests -- --ignored --nocapture
```

## Troubleshooting

### "memcached not found in PATH"

```bash
# Install memcached
brew install memcached  # macOS
sudo apt-get install memcached  # Ubuntu
```

### "memtier_benchmark not found in PATH"

```bash
# Install memtier_benchmark
brew install memtier-benchmark  # macOS
sudo apt-get install memtier  # Ubuntu
```

### "Address already in use"

```bash
# Kill existing memcached
pkill memcached

# Or find process on port 11211
lsof -i :11211
kill -9 <PID>
```

### Test times out

- Check system load: `uptime`
- Reduce test intensity in test code
- Increase timeout values if system is slow

### Incomplete memtier output

- memtier may buffer output
- Use `--nocapture` flag to see output immediately
- Try `--test-threads=1` to run sequentially

## Performance Baseline

Typical results on modern hardware:

| Workload | Clients | Throughput | Avg Latency |
|----------|---------|-----------|-------------|
| Light    | 1       | 1000-2000 | 0.5-1.0 ms  |
| Moderate | 2       | 2000-4000 | 0.5-1.0 ms  |
| Heavy    | 4       | 4000-8000 | 0.8-1.5 ms  |

*Note: These are rough estimates. Actual values depend on hardware and system load.*

## Future Enhancements

Planned improvements to system tests:

1. **Live Packet Capture Integration**
   - Capture real traffic from memtier_benchmark
   - Test full capture→analyze→replay pipeline
   - Verify distribution accuracy

2. **Profile Comparison**
   - Compare captured vs replayed distributions
   - Validate replay accuracy

3. **Performance Regression Detection**
   - Store baseline metrics
   - Alert on performance degradation

4. **Multiple Protocol Support**
   - Add binary protocol tests when implemented
   - Add Meta protocol tests for memcached 1.6+

## See Also

- [README.md](../README.md) - Overview of membench
- [USAGE.md](./USAGE.md) - CLI usage guide
- [tests/e2e_tests.rs](../tests/e2e_tests.rs) - Unit-level integration tests
